(function($,undefined){"use strict";var UTC_DAY_IN_MS=24*60*60*1e3;function findDay(elt,text){var cd=new Date(parseInt(text,10));cd.setHours(0,0,0,0);var id=$(elt).attr("id")||"";var si=id.indexOf("-")+1;var ed=new Date(parseInt(id.substring(si,id.length),10));ed.setHours(0,0,0,0);return cd.getTime()===ed.getTime()}$.expr.pseudos.findday=$.expr.createPseudo?$.expr.createPseudo(function(text){return function(elt){return findDay(elt,text)}}):function(elt,i,match){return findDay(elt,match[3])};function findWeek(elt,text){var cd=new Date(parseInt(text,10));var y=cd.getFullYear();var w=cd.getWeekOfYear();var m=cd.getMonth();if(m===11&&w===1){y++}else if(!m&&w>51){y--}cd=y+"-"+w;var id=$(elt).attr("id")||"";var si=id.indexOf("-")+1;var ed=id.substring(si,id.length);return cd===ed}$.expr.pseudos.findweek=$.expr.createPseudo?$.expr.createPseudo(function(text){return function(elt){return findWeek(elt,text)}}):function(elt,i,match){return findWeek(elt,match[3])};function findMonth(elt,text){var cd=new Date(parseInt(text,10));cd=cd.getFullYear()+"-"+cd.getMonth();var id=$(elt).attr("id")||"";var si=id.indexOf("-")+1;var ed=id.substring(si,id.length);return cd===ed}$.expr[":"].findmonth=$.expr.createPseudo?$.expr.createPseudo(function(text){return function(elt){return findMonth(elt,text)}}):function(elt,i,match){return findMonth(elt,match[3])};Date.prototype.getWeekId=function(){var y=this.getFullYear();var w=this.getWeekOfYear();var m=this.getMonth();if(m===11&&w===1){y++}else if(!m&&w>51){y--}return"dh-"+y+"-"+w};Date.prototype.getRepDate=function(scale){switch(scale){case"hours":return this.getTime();case"weeks":return this.getDayForWeek().getTime();case"months":return new Date(this.getFullYear(),this.getMonth(),1).getTime();case"days":default:return this.getTime()}};Date.prototype.getDayOfYear=function(){var year=this.getFullYear();return(Date.UTC(year,this.getMonth(),this.getDate())-Date.UTC(year,0,0))/UTC_DAY_IN_MS};var firstDay=1;var weekOneDate=4;Date.prototype.getWeekOfYear=function(){var year=this.getFullYear(),month=this.getMonth(),date=this.getDate(),day=this.getDay();var diff=weekOneDate-day;if(day<firstDay){diff-=7}if(diff+7<weekOneDate-firstDay){diff+=7}return Math.ceil(new Date(year,month,date+diff).getDayOfYear()/7)};Date.prototype.getDayForWeek=function(){var day=this.getDay();var diff=(day<firstDay?-7:0)+firstDay-day;return new Date(this.getFullYear(),this.getMonth(),this.getDate()+diff)};$.fn.gantt=function(options){var i18n={en:{dow:["S","M","T","W","T","F","S"],months:["January","February","March","April","May","June","July","August","September","October","November","December"],waitText:"Please wait..."},de:{dow:["S","M","D","M","D","F","S"],months:["Januar","Februar","März","April","Mai","Juni","Juli","August","September","Oktober","November","Dezember"],waitText:"Bitte warten..."},fr:{dow:["D","L","M","M","J","V","S"],months:["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"],waitText:"Veuillez patienter..."}};var scales=["hours","days","weeks","months"];var settings={source:[],holidays:[],itemsPerPage:7,language:"en",dow:i18n.en.dow,months:i18n.en.months,waitText:i18n.en.waitText,navigate:"buttons",scrollToToday:true,shiftKeyToScroll:true,scrollDistance:-50,useStorage:false,storageKey:"jquery.fn.gantt",clearPosition:false,scale:"days",subScale:12,maxScale:"months",minScale:"hours",hideTooltip:false,onItemClick:function(data,event){return},onAddClick:function(dt,rowId,event){return},onRender:$.noop};$.extend(settings,options);if(i18n[settings.language]){settings.dow=i18n[settings.language].dow;settings.months=i18n[settings.language].months;settings.waitText=i18n[settings.language].waitText}if(settings.useStorage){let test="test";try{window.localStorage.setItem(test,test);window.localStorage.removeItem(test)}catch(e){settings.useStorage=false}}if(settings.clearPosition&&settings.useStorage){window.localStorage.removeItem(settings.storageKey+"ScrollPos")}var core={elementFromPoint:function(){if(document.compatMode==="CSS1Compat"){return function(x,y){x-=window.pageXOffset;y-=window.pageYOffset;return document.elementFromPoint(x,y)}}return function(x,y){x-=$(document).scrollLeft();y-=$(document).scrollTop();return document.elementFromPoint(x,y)}}(),create:function(element){if(typeof settings.source!=="string"){element.data=settings.source;core.init(element)}else{$.getJSON(settings.source,function(jsData){element.data=jsData;core.init(element)})}},init:function(element){element.rowsNum=element.data.length;element.pageCount=Math.ceil(element.rowsNum/settings.itemsPerPage);element.rowsOnLastPage=element.rowsNum-Math.floor(element.rowsNum/settings.itemsPerPage)*settings.itemsPerPage;element.dateStart=tools.getMinDate(element);element.dateEnd=tools.getMaxDate(element);core.waitToggle(element,function(){core.render(element)})},render:function(element){var content=$('<div class="fn-content"/>');var $leftPanel=core.leftPanel(element);content.append($leftPanel);var $rightPanel=core.rightPanel(element,$leftPanel);var pLeft,hPos;content.append($rightPanel);content.append(core.navigation(element));var $dataPanel=$rightPanel.find(".dataPanel");element.gantt=$('<div class="fn-gantt" />').append(content);$(element).empty().append(element.gantt);element.scrollNavigation.panelMargin=parseInt($dataPanel.css("left").replace("px",""),10);element.scrollNavigation.panelMaxPos=$dataPanel.width()-$rightPanel.width();element.scrollNavigation.canScroll=$dataPanel.width()>$rightPanel.width();core.fillData(element,$dataPanel);if(settings.useStorage){var sc=window.localStorage.getItem(settings.storageKey+"ScrollPos");if(sc&&sc*-1<=$dataPanel.width()){element.hPosition=sc}}if(settings.scrollToToday){core.navigateTo(element,"now");core.scrollPanel(element,0)}else{if(element.hPosition!==0){if(element.scaleOldWidth){pLeft=$dataPanel.width()-$rightPanel.width();hPos=pLeft*element.hPosition/element.scaleOldWidth;element.hPosition=hPos>0?0:hPos;element.scaleOldWidth=null}console.log(element.hPosition,$dataPanel.width());$dataPanel.css({left:element.hPosition+"px"});element.scrollNavigation.panelMargin=element.hPosition}core.repositionLabel(element)}$dataPanel.css({height:$leftPanel.height()});core.waitToggle(element);settings.onRender()},leftPanel:function(element){var ganttLeftPanel=$('<div class="leftPanel"/>').append($('<div class="row spacer"/>').css("height",tools.getCellSize()*element.headerRows));var entries=[];$.each(element.data,function(i,entry){if(i>=element.pageNum*settings.itemsPerPage&&i<element.pageNum*settings.itemsPerPage+settings.itemsPerPage){var dataId="id"in entry?'" data-id="'+entry.id:"";entries.push('<div class="row name row'+i+(entry.name?"":" fn-0 "+dataId)+(entry.desc?"":" fn-wide "+dataId)+'" id="rowheader'+i+'" data-offset="'+i%settings.itemsPerPage*tools.getCellSize()+'">'+'<span class="fn-label'+(entry.cssClass?" "+entry.cssClass:"")+'">'+(entry.name||"")+"</span>"+"</div>");if(entry.desc){entries.push('<div class="row desc row'+i+(entry.name?"":" fn-wide "+dataId)+'" id="RowdId_'+i+dataId+'">'+'<span class="fn-label'+(entry.cssClass?" "+entry.cssClass:"")+'">'+entry.desc+"</span>"+"</div>")}}});return ganttLeftPanel.append(entries.join(""))},dataPanel:function(element,width){var dataPanel=$('<div class="dataPanel" style="width: '+width+'px;"/>');var wheel="onwheel"in element?"wheel":document.onmousewheel!==undefined?"mousewheel":"DOMMouseScroll";$(element).off(wheel);$(element).on(wheel,onMouseWheel);function onMouseWheel(e){if(settings.shiftKeyToScroll&&!e.shiftKey){return}core.wheelScroll(element,e)}dataPanel.click(function(e){e.stopPropagation();var leftpanel=$(element).find(".fn-gantt .leftPanel");var datapanel=$(element).find(".fn-gantt .dataPanel");var col;datapanel.find(".header > [data-repdate]").each(function(){var $this=$(this);if($this.offset().left+$this.width()>e.pageX&&$this.offset().left<e.pageX){col=$this;return false}});var dt=col.data("repdate");var row=core.elementFromPoint(leftpanel.offset().left+leftpanel.width()-10,e.pageY);if(row.className.indexOf("fn-label")===0){row=$(row.parentNode)}else{row=$(row)}var rowId=row.data("id");settings.onAddClick(dt,rowId,e)});return dataPanel},rightPanel:function(element,leftPanel){var range=null;var dowClass=["sn","wd","wd","wd","wd","wd","sa"];var yearArr=[];var scaleUnitsThisYear=0;var monthArr=[];var scaleUnitsThisMonth=0;var dayArr=[];var hoursInDay=0;var dowArr=[];var horArr=[];var today=new Date;today.setHours(0,0,0,0);var $row=$('<div class="row header"></div>');var i,len;var year,month,week,day;var rday,dayClass;var dataPanel,dataPanelWidth;switch(settings.scale){case"hours":range=tools.parseTimeRange(element.dateStart,element.dateEnd,element.scaleStep);dataPanelWidth=range.length*tools.getCellSize();year=range[0].getFullYear();month=range[0].getMonth();day=range[0];for(i=0,len=range.length;i<len;i++){rday=range[i];var rfy=rday.getFullYear();if(rfy!==year){yearArr.push('<div class="row year" style="width: '+tools.getCellSize()*scaleUnitsThisYear+'px;"><div class="fn-label">'+year+"</div></div>");year=rfy;scaleUnitsThisYear=0}scaleUnitsThisYear++;var rm=rday.getMonth();if(rm!==month){monthArr.push('<div class="row month" style="width: '+tools.getCellSize()*scaleUnitsThisMonth+'px"><div class="fn-label">'+settings.months[month]+"</div></div>");month=rm;scaleUnitsThisMonth=0}scaleUnitsThisMonth++;var rgetDay=rday.getDay();var getDay=day.getDay();if(rgetDay!==getDay){dayClass=today-day===0?" today":tools.isHoliday(day.getTime())?" holiday":"";dayArr.push('<div class="row date '+dowClass[getDay]+dayClass+'" '+'style="width: '+tools.getCellSize()*hoursInDay+'px;">'+'<div class="fn-label">'+day.getDate()+"</div></div>");dowArr.push('<div class="row day '+dowClass[getDay]+" "+dayClass+'" '+'style="width: '+tools.getCellSize()*hoursInDay+'px;">'+'<div class="fn-label">'+settings.dow[getDay]+"</div></div>");day=rday;hoursInDay=0}hoursInDay++;dayClass=dowClass[rgetDay];if(tools.isHoliday(rday)){dayClass="holiday"}horArr.push('<div class="row day '+dayClass+'" id="dh-'+rday.getTime()+'" data-offset="'+i*tools.getCellSize()+'" data-repdate="'+rday.getRepDate(settings.scale)+'"><div class="fn-label">'+rday.getHours()+"</div></div>")}yearArr.push('<div class="row year" style="width: '+tools.getCellSize()*scaleUnitsThisYear+'px;"><div class="fn-label">'+year+"</div></div>");monthArr.push('<div class="row month" style="width: '+tools.getCellSize()*scaleUnitsThisMonth+'px"><div class="fn-label">'+settings.months[month]+"</div></div>");dayClass=dowClass[day.getDay()];if(tools.isHoliday(day)){dayClass="holiday"}dayArr.push('<div class="row date '+dayClass+'" '+'style="width: '+tools.getCellSize()*hoursInDay+'px;">'+'<div class="fn-label">'+day.getDate()+"</div></div>");dowArr.push('<div class="row day '+dayClass+'" '+'style="width: '+tools.getCellSize()*hoursInDay+'px;">'+'<div class="fn-label">'+settings.dow[day.getDay()]+"</div></div>");dataPanel=core.dataPanel(element,dataPanelWidth);dataPanel.append($row.clone().html(yearArr.join("")),$row.clone().html(monthArr.join("")),$row.clone().html(dayArr.join("")),$row.clone().html(dowArr.join("")),$row.clone().html(horArr.join("")));break;case"weeks":range=tools.parseWeeksRange(element.dateStart,element.dateEnd);dataPanelWidth=range.length*tools.getCellSize();year=range[0].getFullYear();month=range[0].getMonth();week=range[0].getWeekOfYear();var diff;for(i=0,len=range.length;i<len;i++){rday=range[i];if(week>(week=rday.getWeekOfYear())){diff=rday.getDate()-1;diff-=!rday.getMonth()?0:31;diff/=7;yearArr.push('<div class="row year" style="width: '+tools.getCellSize()*(scaleUnitsThisYear-diff)+'px;"><div class="fn-label">'+year+"</div></div>");year++;scaleUnitsThisYear=diff}scaleUnitsThisYear++;if(rday.getMonth()!==month){diff=rday.getDate()-1;diff/=7;monthArr.push('<div class="row month" style="width:'+tools.getCellSize()*(scaleUnitsThisMonth-diff)+'px;"><div class="fn-label">'+settings.months[month]+"</div></div>");month=rday.getMonth();scaleUnitsThisMonth=diff}scaleUnitsThisMonth++;dayArr.push('<div class="row day wd"'+' id="'+rday.getWeekId()+'" data-offset="'+i*tools.getCellSize()+'" data-repdate="'+rday.getRepDate(settings.scale)+'">'+'<div class="fn-label">'+week+"</div></div>")}yearArr.push('<div class="row year" style="width: '+tools.getCellSize()*scaleUnitsThisYear+'px;"><div class="fn-label">'+year+"</div></div>");monthArr.push('<div class="row month" style="width: '+tools.getCellSize()*scaleUnitsThisMonth+'px"><div class="fn-label">'+settings.months[month]+"</div></div>");dataPanel=core.dataPanel(element,dataPanelWidth);dataPanel.append($row.clone().html(yearArr.join("")),$row.clone().html(monthArr.join("")),$row.clone().html(dayArr.join("")));break;case"months":range=tools.parseMonthsRange(element.dateStart,element.dateEnd);dataPanelWidth=range.length*tools.getCellSize();year=range[0].getFullYear();month=range[0].getMonth();for(i=0,len=range.length;i<len;i++){rday=range[i];if(rday.getFullYear()!==year){yearArr.push('<div class="row year" style="width: '+tools.getCellSize()*scaleUnitsThisYear+'px;"><div class="fn-label">'+year+"</div></div>");year=rday.getFullYear();scaleUnitsThisYear=0}scaleUnitsThisYear++;monthArr.push('<div class="row day wd" id="dh-'+tools.genId(rday)+'" data-offset="'+i*tools.getCellSize()+'" data-repdate="'+rday.getRepDate(settings.scale)+'">'+(1+rday.getMonth())+"</div>")}yearArr.push('<div class="row year" style="width: '+tools.getCellSize()*scaleUnitsThisYear+'px;"><div class="fn-label">'+year+"</div></div>");dataPanel=core.dataPanel(element,dataPanelWidth);dataPanel.append($row.clone().html(yearArr.join("")),$row.clone().html(monthArr.join("")));break;default:range=tools.parseDateRange(element.dateStart,element.dateEnd);dataPanelWidth=range.length*tools.getCellSize();year=range[0].getFullYear();month=range[0].getMonth();for(i=0,len=range.length;i<len;i++){rday=range[i];if(rday.getFullYear()!==year){yearArr.push('<div class="row year" style="width:'+tools.getCellSize()*scaleUnitsThisYear+'px;"><div class="fn-label">'+year+"</div></div>");year=rday.getFullYear();scaleUnitsThisYear=0}scaleUnitsThisYear++;if(rday.getMonth()!==month){monthArr.push('<div class="row month" style="width:'+tools.getCellSize()*scaleUnitsThisMonth+'px;"><div class="fn-label">'+settings.months[month]+"</div></div>");month=rday.getMonth();scaleUnitsThisMonth=0}scaleUnitsThisMonth++;day=rday.getDay();dayClass=dowClass[day];if(tools.isHoliday(rday)){dayClass="holiday"}dayArr.push('<div class="row date '+dayClass+'"'+' id="dh-'+tools.genId(rday)+'" data-offset="'+i*tools.getCellSize()+'" data-repdate="'+rday.getRepDate(settings.scale)+'">'+'<div class="fn-label">'+rday.getDate()+"</div></div>");dowArr.push('<div class="row day '+dayClass+'"'+' id="dw-'+tools.genId(rday)+'" data-repdate="'+rday.getRepDate(settings.scale)+'">'+'<div class="fn-label">'+settings.dow[day]+"</div></div>")}yearArr.push('<div class="row year" style="width: '+tools.getCellSize()*scaleUnitsThisYear+'px;"><div class="fn-label">'+year+"</div></div>");monthArr.push('<div class="row month" style="width: '+tools.getCellSize()*scaleUnitsThisMonth+'px"><div class="fn-label">'+settings.months[month]+"</div></div>");dataPanel=core.dataPanel(element,dataPanelWidth);dataPanel.append($row.clone().html(yearArr.join("")),$row.clone().html(monthArr.join("")),$row.clone().html(dayArr.join("")),$row.clone().html(dowArr.join("")))}return $('<div class="rightPanel"></div>').append(dataPanel)},navigation:function(element){var ganttNavigate=null;if(settings.navigate==="scroll"){ganttNavigate=$('<div class="navigate" />').append($('<div class="nav-slider" />').append($('<div class="nav-slider-left" />').append($('<button type="button" class="btn btn-primary btn-xs nav-page-back"/>').html("&nbsp;").click(function(){core.navigatePage(element,-1)})).append($('<div class="page-number"/>').append($("<span/>").html(element.pageNum+1+" / "+element.pageCount))).append($('<button type="button" class="btn btn-primary btn-xs nav-page-next"/>').html("&nbsp;").click(function(){core.navigatePage(element,1)})).append($('<button type="button" class="btn btn-primary btn-xs nav-now"/>').html("&nbsp;").click(function(){core.navigateTo(element,"now")})).append($('<button type="button" class="btn btn-primary btn-xs nav-prev-week"/>').html("&nbsp;").click(function(){if(settings.scale==="hours"){core.navigateTo(element,tools.getCellSize()*8)}else if(settings.scale==="days"){core.navigateTo(element,tools.getCellSize()*30)}else if(settings.scale==="weeks"){core.navigateTo(element,tools.getCellSize()*12)}else if(settings.scale==="months"){core.navigateTo(element,tools.getCellSize()*6)}})).append($('<button type="button" class="btn btn-primary btn-xs nav-prev-day"/>').html("&nbsp;").click(function(){if(settings.scale==="hours"){core.navigateTo(element,tools.getCellSize()*4)}else if(settings.scale==="days"){core.navigateTo(element,tools.getCellSize()*7)}else if(settings.scale==="weeks"){core.navigateTo(element,tools.getCellSize()*4)}else if(settings.scale==="months"){core.navigateTo(element,tools.getCellSize()*3)}}))).append($('<div class="nav-slider-content" />').append($('<div class="nav-slider-bar" />').append($('<a class="nav-slider-button" />')).mousedown(function(e){e.preventDefault();element.scrollNavigation.scrollerMouseDown=true;core.sliderScroll(element,e)}).mousemove(function(e){if(element.scrollNavigation.scrollerMouseDown){core.sliderScroll(element,e)}}))).append($('<div class="nav-slider-right" />').append($('<button type="button" class="btn btn-primary btn-xs nav-next-day"/>').html("&nbsp;").click(function(){if(settings.scale==="hours"){core.navigateTo(element,tools.getCellSize()*-4)}else if(settings.scale==="days"){core.navigateTo(element,tools.getCellSize()*-7)}else if(settings.scale==="weeks"){core.navigateTo(element,tools.getCellSize()*-4)}else if(settings.scale==="months"){core.navigateTo(element,tools.getCellSize()*-3)}})).append($('<button type="button" class="btn btn-primary btn-xs nav-next-week"/>').html("&nbsp;").click(function(){if(settings.scale==="hours"){core.navigateTo(element,tools.getCellSize()*-8)}else if(settings.scale==="days"){core.navigateTo(element,tools.getCellSize()*-30)}else if(settings.scale==="weeks"){core.navigateTo(element,tools.getCellSize()*-12)}else if(settings.scale==="months"){core.navigateTo(element,tools.getCellSize()*-6)}})).append($('<button type="button" class="btn btn-primary btn-xs nav-zoomIn"/>').html("&nbsp;").click(function(){core.zoomInOut(element,-1)})).append($('<button type="button" class="btn btn-primary btn-xs nav-zoomOut"/>').html("&nbsp;").click(function(){core.zoomInOut(element,1)}))));$(document).mouseup(function(){element.scrollNavigation.scrollerMouseDown=false})}else{ganttNavigate=$('<div class="navigate" />').append($('<button type="button" class="btn btn-primary btn-xs nav-page-back"/>').html("&nbsp;").click(function(){core.navigatePage(element,-1)})).append($('<div class="page-number"/>').append($("<span/>").html(element.pageNum+1+" / "+element.pageCount))).append($('<button type="button" class="btn btn-primary btn-xs nav-page-next"/>').html("&nbsp;").click(function(){core.navigatePage(element,1)})).append($('<button type="button" class="btn btn-primary btn-xs nav-begin"/>').html("&nbsp;").click(function(){core.navigateTo(element,"begin")})).append($('<button type="button" class="btn btn-primary btn-xs nav-prev-week"/>').html("&nbsp;").mousedown(function(){core.navigateTo(element,tools.getCellSize()*7)})).append($('<button type="button" class="btn btn-primary btn-xs nav-prev-day"/>').html("&nbsp;").mousedown(function(){core.navigateTo(element,tools.getCellSize())})).append($('<button type="button" class="btn btn-primary btn-xs nav-now"/>').html("&nbsp;").click(function(){core.navigateTo(element,"now")})).append($('<button type="button" class="btn btn-primary btn-xs nav-next-day"/>').html("&nbsp;").click(function(){core.navigateTo(element,tools.getCellSize()*-1)})).append($('<button type="button" class="btn btn-primary btn-xs nav-next-week"/>').html("&nbsp;").click(function(){core.navigateTo(element,tools.getCellSize()*-7)})).append($('<button type="button" class="btn btn-primary btn-xs nav-end"/>').html("&nbsp;").click(function(){core.navigateTo(element,"end")})).append($('<button type="button" class="btn btn-primary btn-xs nav-zoomIn"/>').html("&nbsp;").click(function(){core.zoomInOut(element,-1)})).append($('<button type="button" class="btn btn-primary btn-xs nav-zoomOut"/>').html("&nbsp;").click(function(){core.zoomInOut(element,1)}))}return $('<div class="bottom"></div>').append(ganttNavigate)},createProgressBar:function(label,desc,classNames,dataObj){label=label||"";var bar=$('<div class="bar"><div class="fn-label">'+label+"</div></div>").attr("id",core.createBarId(dataObj)).data("dataObj",dataObj).data("label",label).data("desc",desc);if(!settings.hideTooltip&&desc){bar.mouseenter(function(e){var hint=$('<div class="fn-gantt-hint" />').html(desc);$("body").append(hint);hint.css("left",e.pageX);hint.css("top",e.pageY);hint.show()}).mouseleave(function(){$(".fn-gantt-hint").remove()}).mousemove(function(e){$(".fn-gantt-hint").css("left",e.pageX);$(".fn-gantt-hint").css("top",e.pageY+15)})}if(classNames){bar.addClass(classNames)}bar.click(function(e){e.stopPropagation();settings.onItemClick($(this).data("dataObj"),e)});return bar},fillData:function(element,datapanel){var cellWidth=tools.getCellSize();var barOffset=(cellWidth-18)/2;var dataPanelWidth=datapanel.width();var invertColor=function(colStr){try{colStr=colStr.replace("rgb(","").replace(")","");var rgbArr=colStr.split(",");var R=parseInt(rgbArr[0],10);var G=parseInt(rgbArr[1],10);var B=parseInt(rgbArr[2],10);var gray=Math.round((255-(.299*R+.587*G+.114*B))*.9);return"rgb("+gray+", "+gray+", "+gray+")"}catch(err){return""}};for(let i=0;i<element.data.length;i++){let entry=element.data[i];let itemsPerPage=settings.itemsPerPage;let pageNum=element.pageNum;if(i>=pageNum*itemsPerPage&&i<pageNum*itemsPerPage+itemsPerPage){for(let j=0;j<entry.values.length;j++){let day=entry.values[j];var _bar;var from,to,cFrom,cTo,dFrom,dTo,dl,dp;var topEl,top;switch(settings.scale){case"hours":dFrom=tools.genId(tools.dateDeserialize(day.from),element.scaleStep);from=document.getElementById("dh-"+dFrom);dTo=tools.genId(tools.dateDeserialize(day.to),element.scaleStep);to=document.getElementById("dh-"+dTo);cFrom=from.dataset.offset;cTo=to.dataset.offset;dl=Math.floor((cTo-cFrom)/cellWidth)+1;dp=100*(cellWidth*dl-1)/dataPanelWidth;_bar=core.createProgressBar(day.label,day.desc,day.customClass,day.dataObj);topEl=document.getElementById("rowheader"+i);top=cellWidth*5+barOffset+parseInt(topEl.dataset.offset);_bar.css({top:top,left:Math.floor(cFrom),width:dp+"%"});datapanel.append(_bar);break;case"weeks":dFrom=tools.dateDeserialize(day.from);dTo=tools.dateDeserialize(day.to);from=$(element).find("#"+dFrom.getWeekId());cFrom=from.data("offset");to=$(element).find("#"+dTo.getWeekId());cTo=to.data("offset");dl=Math.round((cTo-cFrom)/cellWidth)+1;dp=100*(cellWidth*dl-1)/dataPanelWidth;_bar=core.createProgressBar(day.label,day.desc,day.customClass,day.dataObj);topEl=$(element).find("#rowheader"+i);top=cellWidth*3+barOffset+topEl.data("offset");_bar.css({top:top,left:Math.floor(cFrom),width:dp+"%"});datapanel.append(_bar);break;case"months":dFrom=tools.dateDeserialize(day.from);dTo=tools.dateDeserialize(day.to);if(dFrom.getDate()<=3&&dFrom.getMonth()===0){dFrom.setDate(dFrom.getDate()+4)}if(dFrom.getDate()<=3&&dFrom.getMonth()===0){dFrom.setDate(dFrom.getDate()+4)}if(dTo.getDate()<=3&&dTo.getMonth()===0){dTo.setDate(dTo.getDate()+4)}from=$(element).find("#dh-"+tools.genId(dFrom));cFrom=from.data("offset");to=$(element).find("#dh-"+tools.genId(dTo));cTo=to.data("offset");dl=Math.round((cTo-cFrom)/cellWidth)+1;dp=100*(cellWidth*dl-1)/dataPanelWidth;_bar=core.createProgressBar(day.label,day.desc,day.customClass,day.dataObj);topEl=$(element).find("#rowheader"+i);top=cellWidth*2+barOffset+topEl.data("offset");_bar.css({top:top,left:Math.floor(cFrom),width:dp+"%"});datapanel.append(_bar);break;case"days":default:dFrom=tools.genId(tools.dateDeserialize(day.from));dTo=tools.genId(tools.dateDeserialize(day.to));from=$(element).find("#dh-"+dFrom);cFrom=from.data("offset");dl=Math.round((dTo-dFrom)/UTC_DAY_IN_MS)+1;dp=100*(cellWidth*dl-1)/dataPanelWidth;_bar=core.createProgressBar(day.label,day.desc,day.customClass,day.dataObj);topEl=$(element).find("#rowheader"+i);top=cellWidth*4+barOffset+topEl.data("offset");_bar.css({top:top,left:Math.floor(cFrom),width:dp+"%"});datapanel.append(_bar)}var $l=_bar.find(".fn-label");if($l.length){var gray=invertColor(_bar.css("backgroundColor"));$l.css("color",gray)}}}}},navigateTo:function(element,val){var $rightPanel=$(element).find(".fn-gantt .rightPanel");var $leftpanel=$(element).find(".fn-gantt .leftPanel");var $dataPanel=$rightPanel.find(".dataPanel");var rightPanelWidth=$rightPanel.width();var dataPanelWidth=$dataPanel.width();var shift=function(){core.repositionLabel(element)};var maxLeft,curLeft;switch(val){case"begin":$dataPanel.animate({left:"0"},"fast",shift);element.scrollNavigation.panelMargin=0;break;case"end":var pLeft=dataPanelWidth-rightPanelWidth;element.scrollNavigation.panelMargin=pLeft*-1;$dataPanel.animate({left:"-"+pLeft},"fast",shift);break;case"now":if(!element.scrollNavigation.canScroll||!$dataPanel.find(".today").length){return false}maxLeft=(dataPanelWidth-rightPanelWidth)*-1;curLeft=$dataPanel.css("left").replace("px","");val=$dataPanel.find(".today").offset().left-$dataPanel.offset().left;val*=-1;if(val>0){val=0}else if(val<maxLeft){val=maxLeft}$dataPanel.animate({left:val},"fast",shift);element.scrollNavigation.panelMargin=val;break;case val.toString().match(/^\s*(3[01]|[12][0-9]|0?[1-9])\.(1[012]|0?[1-9])\.((?:19|20)\d{2})\s*$/)?.input:let arr=val.split(".");let date=new Date(arr[2],arr[1]-1,arr[0]);let elem=$('[data-repdate="'+date.getTime()+'"]');if(elem.length>0){maxLeft=(dataPanelWidth-rightPanelWidth)*-1;val=elem.offset().left-$dataPanel.offset().left;val*=-1;if(val>0){val=0}else if(val<maxLeft){val=maxLeft}$dataPanel.animate({left:val},"fast",shift);element.scrollNavigation.panelMargin=val}break;default:maxLeft=(dataPanelWidth-rightPanelWidth)*-1;curLeft=$dataPanel.css("left").replace("px","");val=parseInt(curLeft,10)+val;if(val<=0&&val>=maxLeft){$dataPanel.animate({left:val},"fast",shift)}element.scrollNavigation.panelMargin=val}core.synchronizeScroller(element)},navigatePage:function(element,val){if(element.pageNum+val>=0&&element.pageNum+val<Math.ceil(element.rowsNum/settings.itemsPerPage)){core.waitToggle(element,function(){element.pageNum+=val;element.hPosition=$(".fn-gantt .dataPanel").css("left").replace("px","");element.scaleOldWidth=false;core.init(element)})}},zoomInOut:function(element,val){core.waitToggle(element,function(){var zoomIn=val<0;var scaleSt=element.scaleStep+val*3;scaleSt={4:3,5:6,9:8,11:12}[scaleSt]||(scaleSt<1?1:scaleSt);var scale=settings.scale;var headerRows=element.headerRows;if(settings.scale==="hours"&&scaleSt>=13){scale="days";headerRows=4;scaleSt=13}else if(settings.scale==="days"&&zoomIn){scale="hours";headerRows=5;scaleSt=12}else if(settings.scale==="days"&&!zoomIn){scale="weeks";headerRows=3;scaleSt=13}else if(settings.scale==="weeks"&&!zoomIn){scale="months";headerRows=2;scaleSt=14}else if(settings.scale==="weeks"&&zoomIn){scale="days";headerRows=4;scaleSt=13}else if(settings.scale==="months"&&zoomIn){scale="weeks";headerRows=3;scaleSt=13}if(zoomIn&&$.inArray(scale,scales)<$.inArray(settings.minScale,scales)||!zoomIn&&$.inArray(scale,scales)>$.inArray(settings.maxScale,scales)){core.init(element);return}element.scaleStep=scaleSt;settings.scale=scale;settings.subScale=scaleSt;element.headerRows=headerRows;var $rightPanel=$(element).find(".fn-gantt .rightPanel");var $dataPanel=$rightPanel.find(".dataPanel");element.hPosition=$dataPanel.css("left").replace("px","");element.scaleOldWidth=$dataPanel.width()-$rightPanel.width();if(settings.useStorage){window.localStorage.setItem(settings.storageKey+"CurrentScale",settings.scale);window.localStorage.setItem(settings.storageKey+"CurrentSubScale",settings.subScale);window.localStorage.setItem(settings.storageKey+"ScrollPos",null)}core.init(element)})},mouseScroll:function(element,e){var $dataPanel=$(element).find(".fn-gantt .dataPanel");$dataPanel.css("cursor","move");var bPos=$dataPanel.offset();var mPos=element.scrollNavigation.mouseX===null?e.pageX:element.scrollNavigation.mouseX;var delta=e.pageX-mPos;element.scrollNavigation.mouseX=e.pageX;core.scrollPanel(element,delta);clearTimeout(element.scrollNavigation.repositionDelay);element.scrollNavigation.repositionDelay=setTimeout(core.repositionLabel,50,element)},wheelScroll:function(element,e){e.preventDefault();var delta="detail"in e&&e.detail>0?e.detail:"wheelDelta"in e.originalEvent?-1/120*e.originalEvent.wheelDelta:e.originalEvent.deltaY?e.originalEvent.deltaY/Math.abs(e.originalEvent.deltaY):e.originalEvent.detail;core.scrollPanel(element,settings.scrollDistance*-1*delta);clearTimeout(element.scrollNavigation.repositionDelay);element.scrollNavigation.repositionDelay=setTimeout(core.repositionLabel,50,element)},sliderScroll:function(element,e){var $sliderBar=$(element).find(".nav-slider-bar");var $sliderBarBtn=$sliderBar.find(".nav-slider-button");var $rightPanel=$(element).find(".fn-gantt .rightPanel");var $dataPanel=$rightPanel.find(".dataPanel");var bPos=$sliderBar.offset();var bWidth=$sliderBar.width();var wButton=$sliderBarBtn.width();var pos,pLeft;if(e.pageX>=bPos.left&&e.pageX<=bPos.left+bWidth){pos=e.pageX-bPos.left;pos=pos-wButton/2;$sliderBarBtn.css("left",pos);pLeft=$dataPanel.width()-$rightPanel.width();var pPos=pos*pLeft/bWidth*-1;if(pPos>=0){$dataPanel.css("left","0");element.scrollNavigation.panelMargin=0}else if(pos>=bWidth-wButton*1){$dataPanel.css("left",pLeft*-1);element.scrollNavigation.panelMargin=pLeft*-1}else{$dataPanel.css("left",pPos);element.scrollNavigation.panelMargin=pPos}clearTimeout(element.scrollNavigation.repositionDelay);element.scrollNavigation.repositionDelay=setTimeout(core.repositionLabel,5,element)}},scrollPanel:function(element,delta){if(!element.scrollNavigation.canScroll){return false}var _panelMargin=parseInt(element.scrollNavigation.panelMargin,10)+delta;if(_panelMargin>0){element.scrollNavigation.panelMargin=0;$(element).find(".fn-gantt .dataPanel").css("left",element.scrollNavigation.panelMargin)}else if(_panelMargin<element.scrollNavigation.panelMaxPos*-1){element.scrollNavigation.panelMargin=element.scrollNavigation.panelMaxPos*-1;$(element).find(".fn-gantt .dataPanel").css("left",element.scrollNavigation.panelMargin)}else{element.scrollNavigation.panelMargin=_panelMargin;$(element).find(".fn-gantt .dataPanel").css("left",element.scrollNavigation.panelMargin)}core.synchronizeScroller(element)},synchronizeScroller:function(element){if(settings.navigate!=="scroll"){return}var $rightPanel=$(element).find(".fn-gantt .rightPanel");var $dataPanel=$rightPanel.find(".dataPanel");var $sliderBar=$(element).find(".nav-slider-bar");var $sliderBtn=$sliderBar.find(".nav-slider-button");var bWidth=$sliderBar.width();var wButton=$sliderBtn.width();var pLeft=$dataPanel.width()-$rightPanel.width();var hPos=$dataPanel.css("left")||0;if(hPos){hPos=hPos.replace("px","")}var pos=hPos*bWidth/pLeft-$sliderBtn.width()*.25;pos=pos>0?0:pos*-1>=bWidth-wButton*.75?(bWidth-wButton*1.25)*-1:pos;$sliderBtn.css("left",pos*-1)},repositionLabel:function(element){setTimeout(function(){var $dataPanel;if(!element){$dataPanel=$(".fn-gantt .rightPanel .dataPanel")}else{var $rightPanel=$(element).find(".fn-gantt .rightPanel");$dataPanel=$rightPanel.find(".dataPanel")}if(settings.useStorage){window.localStorage.setItem(settings.storageKey+"ScrollPos",$dataPanel.css("left").replace("px",""))}},500)},waitToggle:function(element,showCallback){if($.isFunction(showCallback)){var $elt=$(element);var eo=$elt.offset();var ew=$elt.outerWidth();var eh=$elt.outerHeight();if(!element.loader){element.loader=$('<div class="fn-gantt-loader">'+'<div class="fn-gantt-loader-spinner"><span>'+settings.waitText+"</span></div></div>")}$elt.append(element.loader);setTimeout(showCallback,500)}else if(element.loader){element.loader.detach()}},createBarId:function(dataObj){return(dataObj["gantt-type"]?dataObj["gantt-type"]+"_":"")+dataObj["id"]}};var tools={getMaxDate:function(element){var maxDate=null;$.each(element.data,function(i,entry){$.each(entry.values,function(i,date){var toDate=tools.dateDeserialize(date.to);if(isNaN(toDate)){return}maxDate=maxDate<toDate?toDate:maxDate})});maxDate=maxDate||new Date;var bd;switch(settings.scale){case"hours":maxDate.setHours(Math.ceil(maxDate.getHours()/element.scaleStep)*element.scaleStep);maxDate.setHours(maxDate.getHours()+element.scaleStep*3);break;case"weeks":bd=new Date(maxDate.getTime());bd=new Date(bd.setDate(bd.getDate()+3*7));var md=Math.floor(bd.getDate()/7)*7;maxDate=new Date(bd.getFullYear(),bd.getMonth(),md===0?4:md-3);break;case"months":bd=new Date(maxDate.getFullYear(),maxDate.getMonth(),1);bd.setMonth(bd.getMonth()+2);maxDate=new Date(bd.getFullYear(),bd.getMonth(),1);break;case"days":default:maxDate.setHours(0);maxDate.setDate(maxDate.getDate()+3)}return maxDate},getMinDate:function(element){var minDate=null;$.each(element.data,function(i,entry){$.each(entry.values,function(i,date){var fromDate=tools.dateDeserialize(date.from);if(isNaN(fromDate)){return}minDate=minDate>fromDate||minDate===null?fromDate:minDate})});minDate=minDate||new Date;switch(settings.scale){case"hours":minDate.setHours(Math.floor(minDate.getHours()/element.scaleStep)*element.scaleStep);minDate.setHours(minDate.getHours()-element.scaleStep*3);break;case"weeks":var bd=new Date(minDate.getTime());bd=new Date(bd.setDate(bd.getDate()-3*7));var md=Math.floor(bd.getDate()/7)*7;minDate=new Date(bd.getFullYear(),bd.getMonth(),md===0?4:md-3);break;case"months":minDate.setHours(0,0,0,0);minDate.setDate(1);minDate.setMonth(minDate.getMonth()-3);break;case"days":default:minDate.setHours(0,0,0,0);minDate.setDate(minDate.getDate()-3)}return minDate},parseDateRange:function(from,to){var year=from.getFullYear();var month=from.getMonth();var date=from.getDate();var range=[],i=0;do{range[i]=new Date(year,month,date+i)}while(range[i++]<to);return range},parseTimeRange:function(from,to,scaleStep){var year=from.getFullYear();var month=from.getMonth();var date=from.getDate();var hour=from.getHours();hour-=hour%scaleStep;var range=[],h=0,i=0;do{range[i]=new Date(year,month,date,hour+h++*scaleStep);if(i>0&&range[i].getHours()===range[i-1].getHours()){i--}}while(range[i++]<to);return range},parseWeeksRange:function(from,to){var current=from.getDayForWeek();var ret=[];var i=0;do{ret[i++]=current.getDayForWeek();current.setDate(current.getDate()+7)}while(current<=to);return ret},parseMonthsRange:function(from,to){var current=new Date(from);var end=new Date(to);var ret=[];var i=0;do{ret[i++]=new Date(current.getFullYear(),current.getMonth(),1);current.setMonth(current.getMonth()+1)}while(current<=to);return ret},dateDeserialize:function(date){if(typeof date==="string"){date=date.replace(/\/Date\((.*)\)\//,"$1");date=$.isNumeric(date)?parseInt(date,10):$.trim(date)}return new Date(date)},genId:function(t){if($.isNumeric(t)){t=new Date(t)}switch(settings.scale){case"hours":var hour=t.getHours();if(arguments.length>=2){hour=Math.floor(t.getHours()/arguments[1])*arguments[1]}return new Date(t.getFullYear(),t.getMonth(),t.getDate(),hour).getTime();case"weeks":var y=t.getFullYear();var w=t.getWeekOfYear();var m=t.getMonth();if(m===11&&w===1){y++}else if(!m&&w>51){y--}return y+"-"+w;case"months":return t.getFullYear()+"-"+t.getMonth();case"days":default:return new Date(t.getFullYear(),t.getMonth(),t.getDate()).getTime()}},_datesToDays:function(dates){var dayMap={};for(var i=0,len=dates.length,day;i<len;i++){day=tools.dateDeserialize(dates[i]);dayMap[day.setHours(0,0,0,0)]=true}return dayMap},isHoliday:function(){if(!settings.holidays||!settings.holidays.length){return function(){return false}}var holidays=false;return function(date){if(!holidays){holidays=tools._datesToDays(settings.holidays)}return!!holidays[$.isNumeric(date)?date:new Date(date.getFullYear(),date.getMonth(),date.getDate()).getTime()]}}(),getCellSize:function(){if(typeof tools._getCellSize==="undefined"){var measure=$('<div style="display: none; position: absolute;" class="fn-gantt"><div class="row"></div></div>');$("body").append(measure);tools._getCellSize=measure.find(".row").height();measure.empty().remove()}return tools._getCellSize},getPageHeight:function(element){return element.pageNum+1===element.pageCount?element.rowsOnLastPage*tools.getCellSize():settings.itemsPerPage*tools.getCellSize()}};this.addItem=function(id,item,refresh=true){if(typeof settings.source!=="string"){for(let i=0;i<settings.source.length;i++){let resource=settings.source[i];if(resource.id==id){resource.values.push(item);break}}}if(refresh){this.refresh()}};this.removeItem=function(id,dataObj){let valueId=dataObj.id;let ganttType=dataObj["gantt-type"];if(typeof settings.source!=="string"){for(let i=0;i<settings.source.length;i++){let resource=settings.source[i];if(resource.id==id){for(let j=0;j<resource.values.length;j++){let value=resource.values[j];if(value.dataObj.id==valueId&&value.dataObj["gantt-type"]==ganttType){resource.values.splice(j,1);break}}break}}}let barId=core.createBarId(dataObj);$("#"+barId).remove()};this.refresh=function(){core.create(this[0])};this.createBarId=function(dataObj){core.createBarId(dataObj)};this.recalculatePanelMaxPos=function(){let dataPanel=$(".gantt .dataPanel");let rightPanel=$(".gantt .rightPanel");if(dataPanel.length===0){return}let max=dataPanel.width()-rightPanel.width();this.prop("scrollNavigation")["panelMaxPos"]=max;let left=parseInt(dataPanel.css("left").replace("px",""));if(left<max*-1){dataPanel.css("left",max*-1+"px");this.prop("scrollNavigation")["panelMargin"]=max*-1}};this.jumpToDate=function(dateStr){core.navigateTo(this[0],dateStr)};return this.each(function(){this.data=null;this.pageNum=0;this.pageCount=0;this.rowsOnLastPage=0;this.rowsNum=0;this.hPosition=0;this.dateStart=null;this.dateEnd=null;this.scrollClicked=false;this.scaleOldWidth=null;this.headerRows=null;if(settings.useStorage){var sc=window.localStorage.getItem(settings.storageKey+"CurrentScale");var ss=window.localStorage.getItem(settings.storageKey+"CurrentSubScale");if(sc){settings.scale=sc}else{window.localStorage.setItem(settings.storageKey+"CurrentScale",settings.scale)}if(ss){settings.subScale=ss}else{window.localStorage.setItem(settings.storageKey+"CurrentSubScale",settings.subScale)}}switch(settings.scale){case"hours":this.headerRows=5;this.scaleStep=settings.subScale;break;case"weeks":this.headerRows=3;this.scaleStep=13;break;case"months":this.headerRows=2;this.scaleStep=14;break;case"days":default:this.headerRows=4;this.scaleStep=13}this.scrollNavigation={panelMouseDown:false,scrollerMouseDown:false,mouseX:null,panelMargin:0,repositionDelay:0,panelMaxPos:0,canScroll:true};this.gantt=null;this.loader=null;core.create(this)})}})(jQuery);